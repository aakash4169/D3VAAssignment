<!DOCTYPE html>
<html>
    <head>
        <title>D3 example</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<meta charset="utf-8">
        <style type="text/css">
        .mycircle {
          fill: blue; 
          stroke: red; 
          stroke-width: 5;
        }
        svg .myrect {
            fill: blue;
            stroke-width: 0px;
        }
        svg .projection {
          fill: white;
        }
		.body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  width: 960px;
  height: 500px;
  position: relative;
}

/* stylesheet for your custom graph */

.categories {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}

.categories-choropleth {
  fill: #ccc;
}

#tooltip-container {
  position: absolute;
  background-color: #fff;
  color: #000;
  padding: 10px;
  border: 1px solid;
  display: none;
}

#canvas svg {
  border: 0px;
}

.tooltip_key {
  font-weight: bold;
}

.tooltip_value {
  margin-left: 20px;
  float: right;
}

.x-axis {
  fill: #000;
}

.chart {
  background: #fff;
  margin: 5px;
}
 
.chart .category-bar {
  stroke: white;
  fill: steelblue;
}
 
.chart .score {
  fill: white;
}
 
.chart text.name {
  fill: #000;
}
 
.chart line {
  stroke: #c1c1c1;
}
 
.chart .rule {
  fill: #000;
}

.main-category-text {
  fill: #FF4A4A;
}

.main-category-bar {
  stroke: #FF4A4A;
  stroke-width: 2px;
}
        </style>
		<div id="barchart"></div>
		<div id="map"></div>
        <div id="tooltip-container"></div>
        <script type="text/javascript">
            var myData;
			var min;
			var max;
			var svg;
            function loadData()
            {
              d3.csv("https://raw.githubusercontent.com/aakash4169/Vega/master/losses2015_transformed.csv",function(data)
              {
                myData = data;
				
				
				
				var byName = d3.nest()
				.key(function(d) { return d.Damage_Descp; })
				.rollup(function(d){ return d3.sum(d,function(g){return g.Amount;})})
				.entries(myData);
				byName.sort(function(x,y){
					return d3.ascending(x.value,y.value);
				});
				console.log(byName[32].value)
				xscale=d3.scaleLinear().domain([byName[0].value,byName[32].value]).range([0,500]);
				ticks=xscale.ticks(5);
				console.log(xscale(byName[32].value))
				//ticks=[0,500,1000,1500,2000,2500,3000]
					console.log(ticks)
				yscale=d3.scaleLinear();
                createBarChart(byName);
				//console.log(byName);
              });
            }
            function createBarChart(byName) {
			var xAxis=d3.axisBottom().scale(xscale);
			//ticks=[0,500,1000,1500,2000,2500];
			//padding=[10,10,10,10,10,10];
			xAxis.tickValues(ticks).tickFormat(function(d){return d/1000000+"M" });
			var counter=0;
             svg  = d3.select("#barchart")
                          .append("svg")
						  //.attr("id","barchart")
                          .attr("width", 1500)
                          .attr("height", 900)
						  .attr("margin",10);
              // generate bars
              svg.selectAll("g")
                  .data(byName)
                  .enter()
                  .append("rect")
                  .attr("x", 225)
                  .attr("y", function(d, i)
                    {
						
                      return (i+1)*(20+2);
                    })
                  .attr("height", 20)
                  .attr("width", function(d, i)
                    {
						//console.log(xscale(d.value))
						//console.log(i)
						//console.log(d.Amount)
						//console.log(1500-xscale(i))
					   
                      return xscale(d.value);
					
                    })
                  .attr("class", "myrect");
              // generate labels
			  
              svg.selectAll("text.Damage_Descp")
                  .data(byName)
                  .enter()
                  .append("text")
                  .text(function(d, i)
                    {
						
						//console.log(d)
                      return d.key;
                    })
                  .attr("x", 0)
                  .attr("y", function(d, i)
                    {
                      return (i+1)*(20+2) + 15;
                    });
					svg.append("line")
					.style("stroke","black")
					.attr("x1",220)
					.attr("y1",22)
					.attr("x2",220)
					.attr("y2",745)
					
				svg.append("g").attr("class","axis").attr("transform","translate(220,745)").call(xAxis)	
              // generate labels
              /*svg.selectAll("text.projection")
                  .data(byName)
                  .enter()
                  .append("text")
                  .text(function(d, i)
                    {
                      return d.Amount + " mil";
                    })
                  .attr("x", function(d, i)
                    {
                      return d.Amount-10;
                    })
                  .attr("class", "projection")
                  .attr("y", function(d, i)
                    {
                      return (i+1)*(20+2) + 15;
                    });*/
            }
            window.onload = loadData;
			
			
			
			
			
			
			
			
			

      var margin = {
          top: 10,
          bottom: 10,
          left: 10,
          right: 10
        };

        var width = 1200 - margin.left - margin.right;
        var height = 1000 - margin.top - margin.bottom;

      
      // define map projection
      var projection = d3.geoAlbersUsa()
        .translate([1000, 400])
        .scale([600]);

      //Define default path generator
      var path = d3.geoPath()
        .projection(projection);

       svg1 = d3.select("#map")
        .append("svg")
        //.attr("id", "map")
        //.attr("width", 3000)
        //.attr("height", 3000)
        .append("g")
        //.attr("tranform", "translate(0" + margin.left + "," + margin.top + ")")
		.attr("mousemove",function(d){
			console.log("hello");
		});
const colors = [
      '#CCE3F2',
      '#99C7E4',
      '#66AAD7',
      '#338EC9',
      '#0072BC',
      '#00568D',
      '#18375F'
    ];
        var color = d3.scaleQuantile()
         // .range(["rgb(237, 248, 233)", "rgb(186, 228, 179)", "rgb(116,196,118)", "rgb(49,163,84)", "rgb(0,109,44)"]);
			.range(colors);
      //d3.csv("https://raw.githubusercontent.com/aakash4169/D3VAAssignment/master/us-cities-agriculture.csv", function(data){
		///console.log(data)
        d3.csv("https://raw.githubusercontent.com/aakash4169/Vega/master/losses2015_transformed.csv",function(data){
		//xyData=ydata;
		var xydata=d3.nest()
				.key(function(d) { return d.State_Abv; })
				.rollup(function(d){ return d3.sum(d,function(g){return g.Amount;})})
				.entries(data);
		color.domain([ d3.min(data, function(d){ return d.Amount; }),
          d3.max(data, function(d){ return d.Amount; })
          ]);

      d3.json("https://raw.githubusercontent.com/aakash4169/D3VAAssignment/master/us-states.json", function(json){
			
       
        for(var i = 0; i < data.length; i++){
          // grab state name
          var dataState = data[i].State_Abv;
          //grab data value, and convert from string to float
          var dataValue = parseFloat(data[i].Amount);
		  

          //find the corresponding state inside the GeoJSON0
          for(var n = 0; n < json.features.length; n++){

            // properties name gets the states name
            var jsonState = json.features[n].properties.name;
            // if statment to merge by name of state
			//console.log(dataState+" hel "+jsonState)
            if(dataState == jsonState){
              //Copy the data value into the JSON
              // basically creating a new value column in JSON data
			 // console.log(dataValue)
              json.features[n].properties.value = dataValue;

              //stop looking through the JSON
              break;
            }
          }
        }
		//console.log(json.features)
        svg.selectAll("path")
          .data(json.features)
          .enter()
          .append("path")
          .attr("d", path)
		  .on("mousemove",function(d){
				var html="";
				var val=d.properties.name;
				var amt=0,name;
				//console.log(xydata)
				for(var i=0;i<xydata.length;i++){
					if(xydata[i].key===val)
					{
						name=xydata[i].key;
						amt=xydata[i].value;
						break;
					}
				}
				html += "<div class=\"tooltip_kv\">";
            html += "<span class=\"tooltip_key\">";
            html+=name;
			html+="<br>"
			html += amt;
            html += "</span>";
            html += "</div>";
			
			$("#tooltip-container").html(html);
            $(this).attr("fill-opacity", "0.8");
            $("#tooltip-container").show();
			var coordinates = d3.mouse(this);
            
            var map_width = 1000;
            
            if (d3.event.pageX < map_width / 2) {
              d3.select("#tooltip-container")
                .style("top", (d3.event.pageY + 15) + "px")
                .style("left", (d3.event.pageX + 15) + "px");
            } else {
              var tooltip_width = $("#tooltip-container").width();
              d3.select("#tooltip-container")
                .style("top", (d3.event.pageY + 15) + "px")
                .style("left", (d3.event.pageX - tooltip_width - 30) + "px");
            }
		  })
		  .on("mouseout", function() {
                $(this).attr("fill-opacity", "1.0");
                $("#tooltip-container").hide();
            })
			.on("click",function(){
				//d3.select("#barchart").remove();
			})
          .style("fill", function(d){
            //get the data value
            var value = d.properties.value;
			//console.log(value)
            if(value){
              //If value exists
              return color(value);
            } else {
              // If value is undefined
              //we do this because alaska and hawaii are not in dataset we are using but still in projections
              return "#ccc"
            }

          });


      });

})
        </script>


    </head>


    <body>

    </body>
</html>